# 문서명: ZFI_APPROVAL_LINE_테이블정의서.md (확장 적용)
- 최종 수정일: 2025-05-23
- 작성자: 송영근
- 내  용: 자산관리 시스템 내 자산 요청(대여, 수선, 리폼, 폐기 등)에 대한 결재 요청 마스터 테이블 정의서로, 결재자 단계 구성, 결재 의견, 첨부파일, 상태 추적, 확장 코멘트 구조 등을 포함한 설계 문서

---

## [1. 테이블명 및 목적]

- 테이블명: `ZFI_APPROVAL_LINE`
- 목적: 요청된 자산행위(대여, 수선 등)에 대해 단계별 결재 흐름을 구성하고,  
  결재 상태, 요청자, 조직, 결재자 처리결과, 첨부파일, 의견을 통합 관리함으로써  
  자산의 상태 제어 및 전자결재 흐름을 완성하는 기준 테이블로 활용된다.

---

## [2. 테이블 구조 (Prisma 기준)]

```prisma
model ZFI_APPROVAL_LINE {
  id             String   @id @default(uuid())    // 결재 요청 ID
  requestType    String                          // 요청 유형 (RENT, REPAIR, REFORM, DISPOSE 등)
  requestId      String                          // 연계 요청 ID (각 자산 요청 테이블 ID)
  orgId          String                          // 요청 조직 ID
  requesterId    String                          // 요청자 ID
  status         String                          // 전체 결재 상태 (PENDING, APPROVED, REJECTED, CANCELED)
  currentStep    Int                             // 현재 결재 단계 번호
  stepCount      Int                             // 전체 결재 단계 수
  isSequential   Boolean  @default(true)         // 순차 결재 여부 (false = 병렬결재)
  finalComment   String?                         // 전체 결재 의견 요약
  completedAt    String?                         // 전체 결재 완료 시각
  createdBy      String
  createdAt      String
  updatedBy      String?
  updatedAt      String?

  steps          ZFI_APPROVAL_LINE_STEP[]
  files          ZFI_APPROVAL_FILE[]
}
````

---

## \[3. 결재자 단계 구성: ZFI\_APPROVAL\_LINE\_STEP]

```prisma
model ZFI_APPROVAL_LINE_STEP {
  id              String   @id @default(uuid())
  approvalLineId  String
  stepNumber      Int                            // 단계 번호 (1, 2, …)
  approverId      String                          // 결재자 ID
  status          String                          // PENDING / APPROVED / REJECTED
  comment         String?                         // 결재 의견
  parentCommentId String?                         // 스레드형 댓글 구조 지원
  approvedAt      String?                         // 결재 처리 시각

  approvalLine    ZFI_APPROVAL_LINE @relation(fields: [approvalLineId], references: [id])
}
```

---

## \[4. 첨부파일 구성: ZFI\_APPROVAL\_FILE]

```prisma
model ZFI_APPROVAL_FILE {
  id              String   @id @default(uuid())
  approvalLineId  String
  fileName        String
  filePath        String
  mimeType        String?
  uploadedBy      String
  uploadedAt      String

  approvalLine    ZFI_APPROVAL_LINE @relation(fields: [approvalLineId], references: [id])
}
```

---

## \[5. 상태 흐름 정의]

| 상태 코드    | 설명             |
| -------- | -------------- |
| PENDING  | 결재 대기 중        |
| APPROVED | 모든 결재 승인 완료    |
| REJECTED | 하나 이상의 결재가 반려됨 |
| CANCELED | 요청자가 취소 처리함    |

---

## \[6. 확장 고려 사항]

| 항목               | 설명                                               |
| ---------------- | ------------------------------------------------ |
| 스레드형 의견 구조       | `parentCommentId`를 활용해 결재의견 답글 작성 가능             |
| 결재 첨부파일 MIME 필터링 | PDF, 이미지 외 차단 가능 (서명 필수문서 구분)                    |
| 반려 시 의견 필수       | `comment IS REQUIRED IF status = REJECTED`       |
| 순차/병렬 혼합         | 단계별 `isParallelGroup` 확장 가능                      |
| UI 전용 View       | 승인/반려 코멘트, 첨부, 처리일 표시용 `ZFI_APPROVAL_VIEW` 별도 구성 |
| 결재자 위임           | 향후 `ZFI_APPROVAL_DELEGATION` 테이블 확장 가능           |
| 승인 완료 후          | SAP 전표 인터페이스 자동 생성 트리거 가능                        |

---

## \[7. 연계 구조]

```txt
ZFI_APPROVAL_LINE
 ├── ZFI_APPROVAL_LINE_STEP  → 결재자별 처리 상태 및 의견
 ├── ZFI_APPROVAL_FILE       → 관련 문서 첨부 (서명, 보고서 등)
 └── 상태 완료 시
      └→ 자산 상태 변경 (ZFI_ASSET_MASTER)
      └→ 자산 이력 기록 (ZFI_ASSET_LOG)
```

---

## \[8. 활용 예시]

* 수선요청 승인 2단계 완료 → 자산 상태 → `REPAIR`
* 폐기요청 반려 → 상태 → `REJECTED`, 반려 의견 기록
* 대여요청 승인 완료 → `ZFI_ASSET_RENT.status = APPROVED`

---

